{% extends 'index.html' %}
{% block content %}
<div class="container my-5">

  <h2 class="mb-4 text-center">My Orders</h2>

  {% for order in orders %}
  <div class="card mb-5 border-dark" style="background-color: #fff; border: 1px solid #000;">
    <div class="card-header" style="background-color: #f8f9fa; border-bottom: 1px solid #000;">
      <!-- <h4>Order #{{ order.id }}</h4> -->
      <small>Placed on: {{ order.created_at|date:"d M, Y H:i" }}</small>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <p><strong>Status:</strong> {{ order.status }}</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p><strong>Total Amount:</strong> ₹{{ order.grand_total|floatformat:2 }}</p>
        </div>
      </div>

      <p><strong>Shipping Address:</strong> 
        {{ order.address }}, {{ order.city }}, {{ order.state }}, {{ order.postal_code }}, {{ order.country }}
      </p>

      <div class="table-responsive">
        <table class="table table-bordered" style="border: 1px solid #000;">
          <thead style="background-color: #f1f1f1; border-bottom: 1px solid #000;">
            <tr>
              <th style="border: 1px solid #000;">Product</th>
              <th style="border: 1px solid #000;">Quantity</th>
              <th style="border: 1px solid #000;">Price</th>
              <th style="border: 1px solid #000;">Discount Price</th>
              <th style="border: 1px solid #000;">Actions</th>
              <th style="border: 1px solid #000;">Review</th>
            </tr>
          </thead>
          <tbody>
            {% for item in order.items.all %}
            <tr>
              <td style="border: 1px solid #000;">
                <a href="{% url 'user:prodCatdetail' item.product.category.slug item.product.slug %}" 
                   style="color: black; text-decoration: none;">
                   {{ item.product.name }}
                </a>
              </td>
              <td style="border: 1px solid #000;">{{ item.quantity }}</td>
              <td style="border: 1px solid #000;">
                ₹{{ item.product.final_price|floatformat:2 }}
              </td>
              <td style="border: 1px solid #000;">
                ₹{{ item.subtotal|floatformat:2 }}
              </td>
              <td style="border: 1px solid #000;">
                {% if item.status == "Cancelled" %}
                  <button class="btn btn-danger btn-sm" disabled>Cancelled</button>
                {% elif item.status == "Delivered" %}
                  <button class="btn btn-success btn-sm" disabled>Delivered</button>
                {% else %}
                  <form method="post" action="{% url 'user:cancel_order_item' item.id %}" style="display:inline;"
                        onsubmit="return confirm('Cancel {{ item.product.name }}?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">Cancel</button>
                  </form>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'user:add_review' item.product.id %}" 
         class="btn btn-sm" 
         style="border: 1px solid #000; color: #000; background-color: #fff;">
         Write Review
      </a>
              </td>
            </tr>
            {% endfor %}

            <!-- Grand Total Row -->
            <tr>
              <td colspan="3" class="text-end"><strong>Grand Total</strong></td>
              <td colspan="3"><strong>₹{{ order.grand_total|floatformat:2 }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Buttons section -->
      <div class="text-end mt-3">
        <!-- {% if order.items.first.product %}
          <a href="{% url 'user:add_review' order.items.first.product.id %}" 
             class="btn btn-sm" 
             style="border: 1px solid #000; color: #000; background-color: #fff;">
             Write Review
          </a>
        {% endif %} -->

        <a href="{% url 'user:order_detail' order.id %}" 
           class="btn btn-sm" 
           style="border: 1px solid #000; color: #000; background-color: #fff;">
           View Details
        </a>

        {% if order.status == "Cancelled" %}
          <button class="btn btn-danger btn-sm" disabled>Cancelled</button>
        {% elif order.status == "Delivered" %}
          <button class="btn btn-success btn-sm" disabled>Delivered</button>
        {% else %}
          <form method="post" action="{% url 'user:cancel_order' order.id %}" style="display:inline;" 
                onsubmit="return confirm('Are you sure you want to cancel this order?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm">Cancel Order</button>
          </form>
        {% endif %}
      </div>

    </div>
  </div>
  {% empty %}
  <div class="text-center" style="border: 1px solid #000; padding: 20px;">
    You have no orders yet.
  </div>
  {% endfor %}

</div>
{% endblock %}
